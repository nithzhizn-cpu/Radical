# analyzer/xai_explainer.py

from typing import Dict

RADICAL_LABELS = {
    "excitable": "–ó–±—É–¥–ª–∏–≤–∏–π",
    "anankast": "–ê–Ω–∞–Ω–∫–∞—Å—Ç–Ω–∏–π",
    "sensetive": "–°–µ–Ω—Å–∏—Ç–∏–≤–Ω–∏–π",
    "epileptoid": "–ï–ø—ñ–ª–µ–ø—Ç–æ—ó–¥–Ω–∏–π",
    "hysteroid": "–Ü—Å—Ç–µ—Ä–æ—ó–¥–Ω–∏–π",
    "harmonic": "–ì–∞—Ä–º–æ–Ω—ñ–π–Ω–∏–π",
    "mixed": "–ó–º—ñ—à–∞–Ω–∏–π",
}


def explain_radical_choice(radical_key: str, features: Dict[str, float]) -> str:
    """
    –§–æ—Ä–º—É—î –ø–æ—è—Å–Ω–µ–Ω–Ω—è ‚Äî —á–æ–º—É —Å–∞–º–µ —Ü–µ–π —Ä–∞–¥–∏–∫–∞–ª –±—É–≤ –ø–µ—Ä–µ–¥–±–∞—á–µ–Ω–∏–π ML –º–æ–¥–µ–ª–ª—é.
    –ü—Ä–∞—Ü—é—î —è–∫ –ø—Å–µ–≤–¥–æ-SHAP –º–æ–¥—É–ª—å: –∞–Ω–∞–ª—ñ–∑—É—î –≤–∞–∂–ª–∏–≤—ñ –≤–∫–ª–∞–¥–∏ –æ–∑–Ω–∞–∫.
    """

    O = features.get("openness")
    C = features.get("conscientiousness")
    E = features.get("extraversion")
    A = features.get("agreeableness")
    N = features.get("neuroticism")

    fwh = features.get("fWHR")
    sym = features.get("symmetry")
    jaw = features.get("jaw")
    brow = features.get("brow")
    eyes = features.get("eyes")

    val = features.get("valence")
    stress = features.get("stress")

    explanation = []

    explanation.append(
        f"üìå –ú–æ–¥–µ–ª—å –æ–±—Ä–∞–ª–∞ —Ä–∞–¥–∏–∫–∞–ª **{RADICAL_LABELS.get(radical_key, radical_key)}**, "
        f"–∞–Ω–∞–ª—ñ–∑—É—é—á–∏ 12 –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏—Ö —ñ —Ñ—ñ–∑—ñ–æ–≥–Ω–æ–º—ñ—á–Ω–∏—Ö –ø–æ–∫–∞–∑–Ω–∏–∫—ñ–≤."
    )

    explanation.append("\n### üîç –û—Å–Ω–æ–≤–Ω—ñ —Ñ–∞–∫—Ç–æ—Ä–∏ —Ä—ñ—à–µ–Ω–Ω—è:")

    # ---------------------------------------------------
    # –ü—Ä–∞–≤–∏–ª–∞ –ø–æ—è—Å–Ω–µ–Ω–Ω—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä–∞–¥–∏–∫–∞–ª–∞
    # ---------------------------------------------------

    if radical_key == "excitable":
        if E > 60: explanation.append("‚Ä¢ –í–∏—Å–æ–∫–∏–π —Ä—ñ–≤–µ–Ω—å –µ–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å—ñ—ó ‚Üí –µ–Ω–µ—Ä–≥—ñ–π–Ω—ñ—Å—Ç—å, —ñ–º–ø—É–ª—å—Å–∏–≤–Ω—ñ—Å—Ç—å.")
        if N > 60: explanation.append("‚Ä¢ –ü—ñ–¥–≤–∏—â–µ–Ω–∏–π –Ω–µ–π—Ä–æ—Ç–∏–∑–º ‚Üí –µ–º–æ—Ü—ñ–π–Ω—ñ —Å–ø–∞–ª–∞—Ö–∏, —Ä–µ–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å.")
        if fwh > 1.9: explanation.append("‚Ä¢ –ü—ñ–¥–≤–∏—â–µ–Ω–∏–π fWHR ‚Üí –¥–æ–º—ñ–Ω–∞–Ω—Ç–Ω—ñ—Å—Ç—å —Ç–∞ –Ω–∞–ø—Ä—É–≥–∞ –º—ñ–º—ñ—á–Ω–æ–≥–æ –∞–ø–∞—Ä–∞—Ç—É.")
        if stress > 0.6: explanation.append("‚Ä¢ –ú—ñ–∫—Ä–æ—Å—Ç—Ä–µ—Å –ø–æ—Å–∏–ª—é—î —ñ–º–ø—É–ª—å—Å–∏–≤–Ω—ñ —Ä–µ–∞–∫—Ü—ñ—ó.")
        if val < 0: explanation.append("‚Ä¢ –ù–µ–≥–∞—Ç–∏–≤–Ω–∞ –≤–∞–ª–µ–Ω—Ç–Ω—ñ—Å—Ç—å –µ–º–æ—Ü—ñ–π ‚Üí —Å—Ö–∏–ª—å–Ω—ñ—Å—Ç—å –¥–æ –Ω–∞–ø—Ä—É–≥–∏.")
        if jaw > 0.55: explanation.append("‚Ä¢ –í–∏—Ä–∞–∂–µ–Ω–∞ —â–µ–ª–µ–ø–∞ ‚Üí —Å–∏–ª–∞ –≤–æ–ª—ñ —Ç–∞ –Ω–∞–ø—Ä—É–≥–∞.")

    if radical_key == "anankast":
        if C > 65: explanation.append("‚Ä¢ –í–∏—Å–æ–∫–∞ —Å—É–º–ª—ñ–Ω–Ω—ñ—Å—Ç—å ‚Üí –ø–µ–¥–∞–Ω—Ç–∏—á–Ω—ñ—Å—Ç—å —Ç–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å.")
        if sym > 0.9: explanation.append("‚Ä¢ –í–∏—Å–æ–∫–∞ —Å–∏–º–µ—Ç—Ä—ñ—è ‚Üí —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å —Ç–∞ –ø–µ—Ä–µ–¥–±–∞—á—É–≤–∞–Ω—ñ—Å—Ç—å.")
        if N < 45: explanation.append("‚Ä¢ –ù–∏–∑—å–∫–∏–π –Ω–µ–π—Ä–æ—Ç–∏–∑–º ‚Üí –µ–º–æ—Ü—ñ–π–Ω–∞ —Å—Ç—Ä–∏–º–∞–Ω—ñ—Å—Ç—å.")
        if jaw > 0.5: explanation.append("‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–∞ –Ω–∏–∂–Ω—è —á–∞—Å—Ç–∏–Ω–∞ –æ–±–ª–∏—á—á—è ‚Üí –¥–∏—Å—Ü–∏–ø–ª—ñ–Ω–∞.")

    if radical_key == "sensetive":
        if N > 70: explanation.append("‚Ä¢ –í–∏—Å–æ–∫–∞ —á—É—Ç–ª–∏–≤—ñ—Å—Ç—å –Ω–µ—Ä–≤–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏ (–Ω–µ–π—Ä–æ—Ç–∏–∑–º).")
        if sym < 0.85: explanation.append("‚Ä¢ –õ–µ–≥–∫–∞ –∞—Å–∏–º–µ—Ç—Ä—ñ—è –º–æ–∂–µ —Å–∏–≥–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ø—ñ–¥–≤–∏—â–µ–Ω—É —Ç—Ä–∏–≤–æ–∂–Ω—ñ—Å—Ç—å.")
        if val < 0: explanation.append("‚Ä¢ –ù–µ–≥–∞—Ç–∏–≤–Ω–∏–π –µ–º–æ—Ü—ñ–π–Ω–∏–π —Ç–æ–Ω ‚Üí –µ–º–æ—Ü—ñ–π–Ω–∞ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å.")
        if dom := features.get("dominant_emotion", "") in ["fear", "sad"]:
            explanation.append("‚Ä¢ –î–æ–º—ñ–Ω—É—é—á–∞ –µ–º–æ—Ü—ñ—è —Å—Ç—Ä–∞—Ö/—Å–º—É—Ç–æ–∫ ‚Üí —Å–µ–Ω—Å–∏—Ç–∏–≤–Ω–∞ –≥–∞–º–∞.")

    if radical_key == "epileptoid":
        if E > 60: explanation.append("‚Ä¢ –ï–Ω–µ—Ä–≥—ñ–π–Ω—ñ—Å—Ç—å ‚Üí –ø—Ä—è–º–æ–ª—ñ–Ω—ñ–π–Ω—ñ —Ä–µ–∞–∫—Ü—ñ—ó.")
        if A < 45: explanation.append("‚Ä¢ –ù–∏–∑—å–∫–∞ –¥–æ–±—Ä–æ–∑–∏—á–ª–∏–≤—ñ—Å—Ç—å ‚Üí –∂–æ—Ä—Å—Ç–∫—ñ—Å—Ç—å.")
        if jaw > 0.6: explanation.append("‚Ä¢ –í–∏—Ä–∞–∂–µ–Ω–∞ —â–µ–ª–µ–ø–∞ ‚Üí –Ω–∞–ø–æ—Ä–∏—Å—Ç—ñ—Å—Ç—å.")
        if fwh > 1.9: explanation.append("‚Ä¢ –®–∏—Ä–æ–∫–µ –ª–∏—Ü–µ (fWHR) ‚Üí –¥–æ–º—ñ–Ω–∞–Ω—Ç–Ω—ñ—Å—Ç—å.")
        if val < 0: explanation.append("‚Ä¢ –ù–µ–≥–∞—Ç–∏–≤–Ω—ñ –µ–º–æ—Ü—ñ—ó –ø—ñ–¥—Å–∏–ª—é—é—Ç—å –∂–æ—Ä—Å—Ç–∫—ñ—Å—Ç—å.")

    if radical_key == "hysteroid":
        if O > 60: explanation.append("‚Ä¢ –í–∏—Å–æ–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—ñ—Å—Ç—å ‚Üí –∞—Ä—Ç–∏—Å—Ç–∏—á–Ω—ñ—Å—Ç—å.")
        if brow > 0.45: explanation.append("‚Ä¢ –ü—ñ–¥–Ω—è—Ç—ñ –±—Ä–æ–≤–∏ ‚Üí –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ—Å—Ç—å.")
        if E > 55: explanation.append("‚Ä¢ –ï–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å—ñ—è ‚Üí –ø–æ—Ç—Ä–µ–±–∞ —É –≤–∑–∞—î–º–æ–¥—ñ—ó.")
        if val > 0: explanation.append("‚Ä¢ –ü–æ–∑–∏—Ç–∏–≤–Ω–∏–π –µ–º–æ—Ü—ñ–π–Ω–∏–π —Ñ–æ–Ω ‚Üí —è—Å–∫—Ä–∞–≤—ñ—Å—Ç—å –ø–æ–≤–µ–¥—ñ–Ω–∫–∏.")

    if radical_key == "harmonic":
        explanation.append("‚Ä¢ –ñ–æ–¥–Ω–∞ –≥—Ä—É–ø–∞ —Ä–∏—Å –Ω–µ –¥–æ–º—ñ–Ω—É—î ‚Üí –±–∞–ª–∞–Ω—Å.")
        if N < 50: explanation.append("‚Ä¢ –ù–∏–∑—å–∫–∏–π –Ω–µ–π—Ä–æ—Ç–∏–∑–º ‚Üí —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å.")
        if A > 55: explanation.append("‚Ä¢ –í–∏—Å–æ–∫–∞ –¥–æ–±—Ä–æ–∑–∏—á–ª–∏–≤—ñ—Å—Ç—å ‚Üí —Å–æ—Ü—ñ–∞–ª—å–Ω–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å.")

    if radical_key == "mixed":
        explanation.append("‚Ä¢ –í–Ω–µ—Å–∫–∏ –∫—ñ–ª—å–∫–æ—Ö –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤ –æ–∑–Ω–∞–∫ ‚Üí –∑–º—ñ—à–∞–Ω–∏–π —Ç–∏–ø.")
        explanation.append("‚Ä¢ –ù–µ–º–∞—î —á—ñ—Ç–∫–æ –¥–æ–º—ñ–Ω—É—é—á–æ–≥–æ –ø–∞—Ç–µ—Ä–Ω—É.")

    # ---------------------------------------------------
    # –î–æ–¥–∞—Ç–∫–æ–≤—ñ —É—Ç–æ—á–Ω–µ–Ω–Ω—è
    # ---------------------------------------------------

    explanation.append("\n### üß™ –£–∑–∞–≥–∞–ª—å–Ω–µ–Ω–Ω—è:")
    explanation.append("–ú–æ–¥–µ–ª—å –∞–Ω–∞–ª—ñ–∑—É—î –ø—Ä–æ–ø–æ—Ä—Ü—ñ—ó –æ–±–ª–∏—á—á—è, –º—ñ–º—ñ–∫—É, –µ–º–æ—Ü—ñ—ó —Ç–∞ Big Five.")
    explanation.append("–í–∏–±—ñ—Ä —Ä–∞–¥–∏–∫–∞–ª–∞ “ë—Ä—É–Ω—Ç—É—î—Ç—å—Å—è –Ω–∞ —Å—É–∫—É–ø–Ω–æ—Å—Ç—ñ —Ñ–∞–∫—Ç–æ—Ä—ñ–≤, –∞ –Ω–µ –æ–∫—Ä–µ–º–æ–º—É –ø–æ–∫–∞–∑–Ω–∏–∫—É.")

    return "\n".join(explanation)