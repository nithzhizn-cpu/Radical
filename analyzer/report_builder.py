# analyzer/report_builder.py

from typing import Dict, Any


def _format_emotion_block(face_info: Dict[str, Any], emotion_data: Dict[str, Any]) -> str:
    dom_emotion = emotion_data.get("dominant_emotion", face_info.get("dominant_emotion", "‚Äî"))
    valence = emotion_data.get("valence", 0)
    emo_scores = emotion_data.get("emotion", face_info.get("emotion", {}))

    lines = []
    lines.append(f"- –î–æ–º—ñ–Ω–∞–Ω—Ç–Ω–∞ –µ–º–æ—Ü—ñ—è: **{dom_emotion}**")
    lines.append(f"- –£–∑–∞–≥–∞–ª—å–Ω–µ–Ω–∞ –µ–º–æ—Ü—ñ–π–Ω–∞ –≤–∞–ª–µ–Ω—Ç–Ω—ñ—Å—Ç—å: **{_valence_label(valence)}** ({valence}/100)")
    if emo_scores:
        top = sorted(emo_scores.items(), key=lambda x: x[1], reverse=True)[:3]
        emo_str = ", ".join(f"{k}: {v:.1f}%" for k, v in top)
        lines.append(f"- –ù–∞–π–≤–∏—Ä–∞–∑–Ω—ñ—à—ñ –µ–º–æ—Ü—ñ—ó –∑–∞ –º–æ–¥–µ–ª–ª—é: {emo_str}")
    return "\n".join(lines)


def _valence_label(v: float) -> str:
    if v > 65:
        return "–ø–µ—Ä–µ–≤–∞–∂–Ω–æ –ø–æ–∑–∏—Ç–∏–≤–Ω–∞"
    if v > 40:
        return "–∑–º—ñ—à–∞–Ω–∞ / –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ-–ø–æ–º—ñ—Ä–Ω–∞"
    return "–ø–µ—Ä–µ–≤–∞–∂–Ω–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞"


def _format_stress_block(stress_data: Dict[str, Any]) -> str:
    lvl = stress_data.get("microstress_level", 0)
    comment = stress_data.get("comment", "")
    label = "–Ω–∏–∑—å–∫–∏–π"
    if lvl >= 70:
        label = "–≤–∏—Å–æ–∫–∏–π"
    elif lvl >= 40:
        label = "–ø–æ–º—ñ—Ä–Ω–∏–π"

    text = f"- –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∏–π —Ä—ñ–≤–µ–Ω—å –º—ñ–∫—Ä–æ—Å—Ç—Ä–µ—Å—É: **{lvl}/100** (—É–º–æ–≤–Ω–æ: *{label}*)"
    if comment:
        text += f"\n- –ö–æ–º–µ–Ω—Ç–∞—Ä –º–æ–¥–µ–ª—ñ: {comment}"
    return text


def _format_big_five(big_five: Dict[str, Any]) -> str:
    return (
        f"- –í—ñ–¥–∫—Ä–∏—Ç—ñ—Å—Ç—å –¥–æ –¥–æ—Å–≤—ñ–¥—É: **{big_five.get('openness', 0)}**\n"
        f"- –°—É–º–ª—ñ–Ω–Ω—ñ—Å—Ç—å: **{big_five.get('conscientiousness', 0)}**\n"
        f"- –ï–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å—ñ—è: **{big_five.get('extraversion', 0)}**\n"
        f"- –î–æ–±—Ä–æ–∂–∏—á–ª–∏–≤—ñ—Å—Ç—å: **{big_five.get('agreeableness', 0)}**\n"
        f"- –ù–µ–π—Ä–æ—Ç–∏–∑–º: **{big_five.get('neuroticism', 0)}**"
    )


def _format_professional(pro: Dict[str, Any]) -> str:
    roles = pro.get("recommended_roles", []) or []
    risks = pro.get("risks", []) or []
    style = pro.get("communication_style", []) or []

    parts = []
    if roles:
        parts.append("**–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ —Ä–æ–ª—ñ:**")
        for r in roles:
            parts.append(f"- {r}")
    if risks:
        parts.append("\n**–ú–æ–∂–ª–∏–≤—ñ —Ä–∏–∑–∏–∫–∏ —É —Ä–æ–±–æ—Ç—ñ:**")
        for r in risks:
            parts.append(f"- {r}")
    if style:
        parts.append("\n**–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–∏–π —Å—Ç–∏–ª—å –≤–∑–∞—î–º–æ–¥—ñ—ó:**")
        for s in style:
            parts.append(f"- {s}")
    return "\n".join(parts)


def _format_physiognomy(phys: Dict[str, Any]) -> str:
    if not phys:
        return (
            "–£ —Ü—ñ–π –≤–µ—Ä—Å—ñ—ó –º–æ–¥–µ–ª—ñ —Ñ—ñ–∑—ñ–æ–≥–Ω–æ–º—ñ—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –æ–±–º–µ–∂–µ–Ω–∏–π. "
            "–û—Å–Ω–æ–≤–Ω–∏–π –∞–∫—Ü–µ–Ω—Ç —Ä–æ–±–∏—Ç—å—Å—è –Ω–∞ –µ–º–æ—Ü—ñ—è—Ö —Ç–∞ –º—ñ–∫—Ä–æ—Å—Ç—Ä–µ—Å—ñ, –∞ –Ω–µ –Ω–∞ "
            "—Ñ–æ—Ä–º—ñ —Ä–∏—Å –æ–±–ª–∏—á—á—è."
        )

    lines = []

    age_morph = phys.get("age_morphology", "")
    gender_morph = phys.get("gender_morphology", "")
    mimic_desc = phys.get("mimic_description", "")
    face_shape = phys.get("face_shape", "")
    scientific_notes = phys.get("scientific_notes", "")

    if age_morph:
        lines.append(f"‚Ä¢ **–í—ñ–∫–æ–≤–∞ –º–æ—Ä—Ñ–æ–ª–æ–≥—ñ—è:** {age_morph}")
    if gender_morph:
        lines.append(f"‚Ä¢ **–ì–µ–Ω–¥–µ—Ä–Ω–æ-–º–æ—Ä—Ñ–æ–ª–æ–≥—ñ—á–Ω—ñ –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:** {gender_morph}")
    if mimic_desc:
        lines.append(f"‚Ä¢ **–ú—ñ–º—ñ–∫–∞ —Ç–∞ –º º—è–∑–æ–≤–∞ –Ω–∞–ø—Ä—É–≥–∞:** {mimic_desc}")
    if face_shape:
        lines.append(f"‚Ä¢ **–§–æ—Ä–º–∞ / —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±–ª–∏—á—á—è (–æ–±–º–µ–∂–µ–Ω–∏–π –æ–ø–∏—Å):** {face_shape}")

    if scientific_notes:
        lines.append("\n> üß™ *–ù–∞—É–∫–æ–≤–µ –∑–∞—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è:*")
        lines.append(f"> {scientific_notes}")

    return "\n".join(lines)


def build_full_report(
    face_info: Dict[str, Any],
    emotion_data: Dict[str, Any],
    stress_data: Dict[str, Any],
    personality: Dict[str, Any],
    professional: Dict[str, Any],
    physiognomy: Dict[str, Any],
) -> str:
    """
    –§–æ—Ä–º—É—î –æ–¥–∏–Ω –≤–µ–ª–∏–∫–∏–π —Ç–µ–∫—Å—Ç–æ–≤–∏–π –∑–≤—ñ—Ç.

    ‚ö†Ô∏è –¶–µ –ù–ï –º–µ–¥–∏—á–Ω–∞, –ù–ï –∫–ª—ñ–Ω—ñ—á–Ω–∞ —ñ –ù–ï —é—Ä–∏–¥–∏—á–Ω–∞ –µ–∫—Å–ø–µ—Ä—Ç–∏–∑–∞.
    –ó–≤—ñ—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ —Å—É—Ç–æ –¥–ª—è —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å—ñ—ó, HR-–æ—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É
    —Ç–∞ —ñ–ª—é—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏—Ö —Ü—ñ–ª–µ–π.
    """

    age = face_info.get("age", "‚Äî")
    gender = face_info.get("gender", "‚Äî")
    dom_race = face_info.get("dominant_race", "‚Äî")

    # –†–∞–¥–∏–∫–∞–ª
    radical_name = personality.get("radical", "‚Äî")
    radical_code = personality.get("radical_code") or personality.get("radical_key")

    big_five = personality.get("big_five_scores", {}) or {}

    # –ë–∞–∑–æ–≤—ñ –±–ª–æ–∫–∏
    emotion_block = _format_emotion_block(face_info, emotion_data)
    stress_block = _format_stress_block(stress_data)
    big_five_block = _format_big_five(big_five)
    professional_block = _format_professional(professional)
    physiognomy_block = _format_physiognomy(physiognomy)

    report = f"""
üß† **–ü—Å–∏—Ö–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç –∑–∞ —Ñ–æ—Ç–æ (–µ–≤—Ä–∏—Å—Ç–∏—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑)**

---

## 1. –ë–∞–∑–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –æ–±–ª–∏—á—á—è

- –û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∏–π –≤—ñ–∫ (–∑–∞ –º–æ–¥–µ–ª–ª—é): **{age}**
- –°—Ç–∞—Ç—å (–º–æ–¥–µ–ª–ª—é —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ —è–∫): **{gender}**
- –î–æ–º—ñ–Ω–∞–Ω—Ç–Ω–∏–π —Ä–∞—Å–æ–≤–∏–π —Ç–∏–ø (–º–æ–¥–µ–ª—å): **{dom_race}**

> –¶—ñ –¥–∞–Ω—ñ –æ—Ç—Ä–∏–º–∞–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —ñ –º–æ–∂—É—Ç—å –ø–æ–º–∏–ª—è—Ç–∏—Å—è. –í–æ–Ω–∏ –ù–ï –ø–æ–≤–∏–Ω–Ω—ñ
> –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è —è–∫ –ø—ñ–¥—Å—Ç–∞–≤–∞ –¥–ª—è –¥–∏—Å–∫—Ä–∏–º—ñ–Ω–∞—Ü—ñ—ó –∞–±–æ —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø—ñ–≤.

---

## 2. –ï–º–æ—Ü—ñ–π–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å

{emotion_block}

---

## 3. –†—ñ–≤–µ–Ω—å –Ω–∞–ø—Ä—É–≥–∏ / –º—ñ–∫—Ä–æ—Å—Ç—Ä–µ—Å—É

{stress_block}

---

## 4. –û—Å–æ–±–∏—Å—Ç—ñ—Å–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å (Big Five + —Ä–∞–¥–∏–∫–∞–ª)

- –ô–º–æ–≤—ñ—Ä–Ω–∏–π –ø—Ä–æ–≤—ñ–¥–Ω–∏–π —Ä–∞–¥–∏–∫–∞–ª (–ü–æ–Ω–æ–º–∞—Ä–µ–Ω–∫–æ): **{radical_name}** ({radical_code or '–∫–æ–¥ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–æ'})

{big_five_block}

> –í–∞–∂–ª–∏–≤–æ: —Ü–µ –ª–∏—à–µ –æ—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∞ –æ—Ü—ñ–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ–¥–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–Ω–æ–≥–æ —Ñ–æ—Ç–æ
> —Ç–∞ –º–æ–¥–µ–ª—ñ. –î–ª—è —Å–µ—Ä–π–æ–∑–Ω–∏—Ö –≤–∏—Å–Ω–æ–≤–∫—ñ–≤ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø–æ–≤–Ω–æ—Ü—ñ–Ω–Ω—ñ –ø—Å–∏—Ö–æ–¥—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω—ñ
> –º–µ—Ç–æ–¥–∏–∫–∏, —ñ–Ω—Ç–µ—Ä–≤ º—é —Ç–∞ —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è —É –¥–∏–Ω–∞–º—ñ—Ü—ñ.

---

## 5. –§—ñ–∑—ñ–æ–≥–Ω–æ–º—ñ—á–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å (–æ–±–µ—Ä–µ–∂–Ω–∏–π –Ω–∞—É–∫–æ–≤–∏–π –ø—ñ–¥—Ö—ñ–¥)

–£ —Ü—å–æ–º—É —Ä–æ–∑–¥—ñ–ª—ñ –ù–ï —Ä–æ–±–ª—è—Ç—å—Å—è –∂–æ—Ä—Å—Ç–∫—ñ –≤–∏—Å–Ω–æ–≤–∫–∏ –ø—Ä–æ ¬´—Ö–∞—Ä–∞–∫—Ç–µ—Ä –∑–∞ —Ä–∏—Å–∞–º–∏ –æ–±–ª–∏—á—á—è¬ª.
–ú–µ—Ç–∞ ‚Äî –æ–ø–∏—Å–∞—Ç–∏, —è–∫ –º–æ–∂—É—Ç—å —Å–ø—Ä–∏–π–º–∞—Ç–∏—Å—è —Ä–∏—Å–∏ —Ç–∞ –º—ñ–º—ñ–∫–∞ –∑ –ø–æ–≥–ª—è–¥—É
–∑–∞–≥–∞–ª—å–Ω–æ—ó –Ω–µ–≤–µ—Ä–±–∞–ª—å–Ω–æ—ó –ø–æ–≤–µ–¥—ñ–Ω–∫–∏.

{physiognomy_block}

---

## 6. –ü–æ–≤–µ–¥—ñ–Ω–∫–∞ —É —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—ñ —Ç–∞ —Å—Ç–æ—Å—É–Ω–∫–∞—Ö (–µ–≤—Ä–∏—Å—Ç–∏—á–Ω–∏–π –æ–≥–ª—è–¥)

–ù–∞ –æ—Å–Ω–æ–≤—ñ –µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é, –º—ñ–∫—Ä–æ—Å—Ç—Ä–µ—Å—É —Ç–∞ –æ—Å–æ–±–∏—Å—Ç—ñ—Å–Ω–∏—Ö —Ä–∏—Å –º–æ–∂–Ω–∞ –ø—Ä–∏–ø—É—Å—Ç–∏—Ç–∏:

- –°—Ö–∏–ª—å–Ω—ñ—Å—Ç—å –¥–æ –ø–µ–≤–Ω–æ–≥–æ —Å—Ç–∏–ª—é –µ–º–æ—Ü—ñ–π–Ω–æ–≥–æ —Ä–µ–∞–≥—É–≤–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –±—ñ–ª—å—à —Å—Ç—Ä–∏–º–∞–Ω–æ–≥–æ –∞–±–æ –±—ñ–ª—å—à –µ–∫—Å–ø—Ä–µ—Å–∏–≤–Ω–æ–≥–æ).
- –í–∏—Ä–∞–∑ –æ—á–µ–π —Ç–∞ –º—ñ–º—ñ–∫–∞ –º–æ–∂—É—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –ø–µ—Ä—à–µ –≤—Ä–∞–∂–µ–Ω–Ω—è (—Ç–µ–ø–ª–µ, –Ω–∞—Å—Ç–æ—Ä–æ–∂–µ–Ω–µ, –∑–æ—Å–µ—Ä–µ–¥–∂–µ–Ω–µ —Ç–æ—â–æ), –∞–ª–µ —Ü–µ –≤—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–≤–∂–¥–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ —Ä–µ–∞–ª—å–Ω–∏–º–∏ –¥—ñ—è–º–∏ –ª—é–¥–∏–Ω–∏.
- –ü–æ—Ç–æ—á–Ω–∏–π –µ–º–æ—Ü—ñ–π–Ω–∏–π —Ñ–æ–Ω –Ω–∞ —Ñ–æ—Ç–æ –º–æ–∂–µ –≤—ñ–¥—Ä—ñ–∑–Ω—è—Ç–∏—Å—è –≤—ñ–¥ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –ª—é–¥–∏–Ω–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É –∂–∏—Ç—Ç—ñ.

---

## 7. –ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å —Ç–∞ HR-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

{professional_block}

> –¶–µ–π –±–ª–æ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —è–∫ –¥–æ–ø–æ–º—ñ–∂–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è HR / –∫–æ—É—á–∏–Ω–≥—É, –∞ –Ω–µ —è–∫
> –æ—Å—Ç–∞—Ç–æ—á–Ω–∏–π ¬´–≤–∏—Ä–æ–∫¬ª. –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –ø–æ—î–¥–Ω—É–≤–∞—Ç–∏ —Ç–∞–∫—ñ –∑–≤—ñ—Ç–∏ –∑ —ñ–Ω—Ç–µ—Ä–≤ º—é,
> —Ç–µ—Å—Ç–∞–º–∏ —Ç–∞ —Ä–µ–∞–ª—å–Ω–∏–º–∏ –∫–µ–π—Å–∞–º–∏ –ø–æ–≤–µ–¥—ñ–Ω–∫–∏.

---

## 8. –û–±–º–µ–∂–µ–Ω–Ω—è —Ç–∞ –µ—Ç–∏—á–Ω—ñ –∑–∞—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è

- –ú–æ–¥–µ–ª—å –∞–Ω–∞–ª—ñ–∑—É—î –ª–∏—à–µ **–æ–¥–Ω–µ —Ñ–æ—Ç–æ** –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –º–æ–º–µ–Ω—Ç —á–∞—Å—É.
- –í–∏—Ä–∞–∑ –æ–±–ª–∏—á—á—è –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É, –Ω–∞—Å—Ç—Ä–æ—é, –æ—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è, –ø–æ–∑–∏.
- –ù–µ –º–æ–∂–Ω–∞ —Ä–æ–±–∏—Ç–∏ —Å–µ—Ä–π–æ–∑–Ω—ñ –∂–∏—Ç—Ç—î–≤—ñ, —é—Ä–∏–¥–∏—á–Ω—ñ –∞–±–æ –º–µ–¥–∏—á–Ω—ñ –≤–∏—Å–Ω–æ–≤–∫–∏
  —Ç—ñ–ª—å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ü—å–æ–≥–æ –∑–≤—ñ—Ç—É.
- –ë—É–¥—å-—è–∫—ñ —Ä—ñ—à–µ–Ω–Ω—è, —â–æ —Å—Ç–æ—Å—É—é—Ç—å—Å—è –ª—é–¥–µ–π (–Ω–∞–π–º, –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è, –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞),
  –º–∞—é—Ç—å –ø—Ä–∏–π–º–∞—Ç–∏—Å—è –ª—é–¥—å–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–∏—Ä–æ–∫–æ–≥–æ –Ω–∞–±–æ—Ä—É –¥–∞–Ω–∏—Ö, –∞ –Ω–µ –ª–∏—à–µ
  –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É.

üßæ *–ó–≤—ñ—Ç —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–æ—é —Å–∏—Å—Ç–µ–º–æ—é –¥–ª—è —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å—ñ—ó —Ç–∞ HR-–∞–Ω–∞–ª—ñ—Ç–∏–∫–∏.*
"""

    # –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∑–∞–π–≤—ñ –ø–æ–¥–≤—ñ–π–Ω—ñ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏
    while "\n\n\n" in report:
        report = report.replace("\n\n\n", "\n\n")

    return report.strip()